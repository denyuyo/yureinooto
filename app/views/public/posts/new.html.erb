<div class="container" style="margin-top: 33px; margin-bottom: 22px; font-family: 'Yusei Magic', sans-serif;">
  <h3 style="font-size: 33px;">つぶやく</h3>

  <!-- タグ作成フォーム -->
  <div class="col-8 mx-auto form-group" id="new-tag-form" style="display: none; position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.6); padding: 30px; z-index: 9999;">
    <table class="table table-borderless">
      <tr>
        <td>
          <%= form_with model: @tag, class: "form-inline", local: false do |f| %>
            <%= f.text_field :tag_name, placeholder: "新しいタグ", class: "form-control mr-2", style: "width: 70%" %>
            <%= f.submit "作成", class: "btn btn-primary", style: "width: 25%" %><br>
          <% end %>
        </td>
      </tr>
    </table>
  </div>

  <!-- ポスト作成フォーム -->
  <%= form_for(@post, html: { class: 'form', multipart: true }) do |f| %>
    <div class="form-group">
      <%= f.label :title, style: "font-family: 'Monomaniac One', sans-serif;" %>
      <div class="col-sm-6">
        <%= f.text_field :title, class: 'form-control', style: "font-family: 'Yusei Magic', sans-serif;" %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :content, style: "font-family: 'Monomaniac One', sans-serif;" %>
      <div class="col-sm-6">
        <%= f.text_area :content, class: 'form-control', style: "font-family: 'Yusei Magic', sans-serif;" %>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :image, style: "font-family: 'Yusei Magic', sans-serif;" %>
      <div class="col-sm-6">
        <%= f.file_field :image, class: 'form-control', accept: ".jpg, .png", id: "post_image" %>
        <br>
        <div id="image-preview"></div>
      </div>
    </div>

    <div class="form-group">
      <%= f.label :tags, style: "font-family: 'Yusei Magic', sans-serif;" %>
      <div class="col-sm-6">
        <%= f.collection_select :tag_ids, Tag.all, :id, :tag_name, { prompt: "タグを選ぶ" }, { multiple: true, class: 'form-control' } %>
        <br>
        <%= link_to "ぴったりなタグがない?", "", id: "new-tag-link", class: "btn btn-secondary" %>
      </div>
    </div>

    <div class="text-align: right;">
      <%= f.submit "つぶやく", class: 'btn btn-primary button-depress', style: "font-family: 'Yusei Magic', sans-serif;" %>
      <%= link_to posts_path, class: 'btn btn-secondary button-depress', style: "font-family: 'Yusei Magic', sans-serif;" do %>
        <i class="fas fa-undo-alt"></i>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  // DOMが完全にロードされた後に実行
  document.addEventListener("DOMContentLoaded", function () {
    // "new-tag-form"である要素を取得し、表示/非表示を切り替える
    // "new-tag-link"である要素を取得し、フォームを表示する
    const newTagForm = document.getElementById("new-tag-form");
    const newTagLink = document.getElementById("new-tag-link");
    // click"イベントリスナーを登録。リンク要素がクリックされた時に指定された関数が実行される
    newTagLink.addEventListener("click", function (e) {
      // イベントのデフォルトの動作をキャンセル。ページ遷移が行われなくなる
      e.preventDefault();
      // 表示スタイルを"block"に設定。これにより、フォームが表示される
      newTagForm.style.display = "block";
    });
    // ドキュメント全体に対して"click"イベントリスナーを登録。ドキュメント内のどの要素がクリックされても指定された関数が実行される
    document.addEventListener("click", function (e) {
      // クリックイベントが発生した要素がnewTagForm要素自体やnewTagLink要素ではない場合に指定されたコードを実行する
      if (!newTagForm.contains(e.target) && e.target !== newTagLink) {
        // 表示スタイルを"none"に設定。これにより、フォームが非表示になる
        newTagForm.style.display = "none";
      }
    });
  });
  // 画像プレビュー
  function readURL(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      reader.onload = function (e) {
        $('#image-preview').html('<img src="' + e.target.result + '" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">');
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  $(document).on('change', '#post_image', function () {
    readURL(this);
  });
</script>
